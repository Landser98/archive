# Документация Batch-файлов для парсинга банковских выписок

Эта документация описывает входные и выходные данные для каждого batch-файла парсера банковских выписок.

---

## 1. Alatau City Bank

**Файл:** `src/alatau_city_bank/batch_parse.py`

### Input (Входные данные)
- **PDF файлы**: Выписки Alatau City Bank в формате PDF
  - Расположение: `data/alatau_city_bank/*.pdf`
  - Можно указать один файл или директорию с файлами

### Промежуточные файлы (создаются автоматически)
- **JSON метаданные**: `data/alatau_city_bank/converted_jsons/<stem>.json`
  - Содержит метаданные PDF (версия, создатель, даты создания/модификации, структура страниц)

### Output (Выходные данные)
Все файлы сохраняются в директории `data/alatau_city_bank_out/` (или указанной через `--out-dir`):

1. **`<stem>_header.csv`** - Заголовок выписки
   - Содержит информацию о периоде, счете, начальном/конечном остатке

2. **`<stem>_tx.csv`** - Транзакции
   - Все операции из выписки с датами, суммами, назначением платежа

3. **`<stem>_footer.csv`** - Итоговая информация
   - Итоговые обороты, остатки

4. **`<stem>_meta.csv`** - Метаданные обработки
   - Информация о банке, исходном PDF, флаги валидации, отладочная информация

5. **`<stem>_tx_ip.csv`** - Транзакции с флагами ИП
   - Обогащенные транзакции с пометками о доходах ИП

6. **`<stem>_ip_income_monthly.csv`** - Доходы ИП по месяцам
   - Агрегированные доходы по месяцам за указанный период (по умолчанию 12 месяцев)

7. **`<stem>_income_summary.csv`** - Сводка по доходам ИП
   - Общая сумма доходов, скорректированная сумма (с учетом исключений)

---

## 2. BCC (Bank CenterCredit)

**Файл:** `src/bcc/batch_parse.py`

### Input (Входные данные)
- **PDF файлы**: Выписки BCC в формате PDF
  - Расположение: `data/bcc/*.pdf`
  - Можно указать один файл или директорию с файлами

### Промежуточные файлы (создаются автоматически)
- **JSONL страниц**: `data/bcc/converted_jsons/<stem>_pages.jsonl`
  - Постраничный дамп PDF в формате pdfplumber
- **JSON метаданные**: `data/bcc/pdf_meta/<stem>.json`
  - Метаданные PDF (версия, создатель, даты, структура)

### Output (Выходные данные)
Все файлы сохраняются в директории `data/bcc_out/` (или указанной через `--out-dir`):

1. **`<stem>_header.csv`** - Заголовок выписки
   - Период, счет, остатки

2. **`<stem>_transactions.csv`** - Транзакции
   - Все операции с датами, кредитами, дебетами, КНП, назначением, корреспондентом

3. **`<stem>_footer.csv`** - Итоговая информация
   - Итоговые обороты и остатки

4. **`<stem>_meta.csv`** - Метаданные обработки
   - Банк, исходный PDF, JSONL файл, флаги валидации, отладочная информация

5. **`<stem>_tx_ip_enriched.csv`** - Транзакции с флагами ИП
   - Обогащенные транзакции с пометками о доходах ИП

6. **`<stem>_ip_income_monthly.csv`** - Доходы ИП по месяцам
   - Агрегированные доходы по месяцам

7. **`<stem>_income_summary.csv`** - Сводка по доходам ИП
   - Общая и скорректированная сумма доходов

---

## 3. Eurasian Bank

**Файл:** `src/eurasian_bank/batch_parse.py`

### Input (Входные данные)
- **PDF файлы**: Выписки Eurasian Bank в формате PDF
  - Расположение: `data/eurasian_bank/*.pdf`
  - Можно указать один файл или директорию с файлами

### Промежуточные файлы (создаются автоматически)
- **JSON метаданные**: `data/eurasian_bank/pdf_meta/<stem>.json`
  - Метаданные PDF (версия, создатель, даты, структура страниц)

### Output (Выходные данные)
Все файлы сохраняются в директории `data/eurasian_bank_out/` (или указанной через `--out-dir`):

1. **`<stem>_header.csv`** - Заголовок выписки
   - Период, счет, остатки, обороты

2. **`<stem>_tx.csv`** - Транзакции
   - Все операции с датами, кредитами, дебетами, КНП, назначением, бенефициаром

3. **`<stem>_footer.csv`** - Итоговая информация
   - Итоговые обороты и остатки

4. **`<stem>_meta.csv`** - Метаданные обработки
   - Банк, исходный PDF, флаги валидации, отладочная информация

5. **`<stem>_tx_ip.csv`** - Транзакции с флагами ИП
   - Обогащенные транзакции с пометками о доходах ИП

6. **`<stem>_ip_income_monthly.csv`** - Доходы ИП по месяцам
   - Агрегированные доходы по месяцам

7. **`<stem>_income_summary.csv`** - Сводка по доходам ИП
   - Общая и скорректированная сумма доходов

---

## 4. Forte Bank

**Файл:** `src/forte_bank/batch_parse.py`

### Input (Входные данные)
- **PDF файлы**: Выписки Forte Bank в формате PDF
  - Расположение: `data/forte_bank/*.pdf`
  - Можно указать один файл или директорию с файлами

### Промежуточные файлы (создаются автоматически)
- **JSONL страниц**: `data/forte_bank/converted_jsons/<stem>_pages.jsonl`
  - Постраничный дамп PDF в формате pdfplumber
- **JSON метаданные**: `data/forte_bank/pdf_meta/<stem>.json`
  - Метаданные PDF (версия, создатель, даты, структура)

### Output (Выходные данные)
Все файлы сохраняются в директории `data/forte_bank_out/` (или указанной через `--out-dir`):

1. **`<stem>_header.csv`** - Заголовок выписки
   - Период, счет, остатки, обороты

2. **`<stem>_tx.csv`** - Транзакции
   - Все операции с датами, кредитами, дебетами, КНП (извлекается из назначения), назначением, отправителем

3. **`<stem>_footer.csv`** - Итоговая информация
   - Итоговые обороты и остатки

4. **`<stem>_meta.csv`** - Метаданные обработки
   - Банк, исходный PDF, JSONL файл, флаги валидации, отладочная информация

5. **`<stem>_tx_ip.csv`** - Транзакции с флагами ИП
   - Обогащенные транзакции с пометками о доходах ИП

6. **`<stem>_ip_income_monthly.csv`** - Доходы ИП по месяцам
   - Агрегированные доходы по месяцам

7. **`<stem>_income_summary.csv`** - Сводка по доходам ИП
   - Общая и скорректированная сумма доходов

---

## 5. Freedom Bank

**Файл:** `src/freedom_bank/batch_parse.py`

### Input (Входные данные)
- **PDF файлы**: Выписки Freedom Bank в формате PDF
  - Расположение: `data/freedom/*.pdf`
  - Можно указать один файл или директорию с файлами

### Промежуточные файлы (создаются автоматически)
- **JSON метаданные**: `data/freedom/pdf_meta/<stem>.json`
  - Метаданные PDF (версия, создатель, даты, структура страниц)

### Output (Выходные данные)
Все файлы сохраняются в директории `data/freedom_out/` (или указанной через `--out-dir`):

1. **`<stem>_header.csv`** - Заголовок выписки
   - Период, счет, остатки

2. **`<stem>_tx.csv`** - Транзакции
   - Все операции с датами, кредитами, дебетами, назначением, корреспондентом
   - КНП отсутствует в выписке (заполняется пустыми значениями)

3. **`<stem>_footer.csv`** - Итоговая информация
   - Итоговые обороты и остатки

4. **`<stem>_meta.csv`** - Метаданные обработки
   - Банк, исходный PDF, флаги валидации, отладочная информация

5. **`<stem>_tx_ip.csv`** - Транзакции с флагами ИП
   - Обогащенные транзакции с пометками о доходах ИП

6. **`<stem>_ip_income_monthly.csv`** - Доходы ИП по месяцам
   - Агрегированные доходы по месяцам

7. **`<stem>_income_summary.csv`** - Сводка по доходам ИП
   - Общая и скорректированная сумма доходов

---

## 6. Halyk Bank Business

**Файл:** `src/halyk_business/batch_parse.py`

### Input (Входные данные)
- **PDF файлы**: Выписки Halyk Bank (бизнес) в формате PDF
  - Расположение: `data/halyk_business/*.pdf`
  - Можно указать один файл или директорию с файлами

### Промежуточные файлы (создаются автоматически)
- **JSONL страниц**: `data/halyk_business/converted_jsons/<stem>_pages.jsonl`
  - Постраничный дамп PDF в формате pdfplumber
- **JSON метаданные**: `data/halyk_business/pdf_meta/<stem>.json`
  - Метаданные PDF (версия, создатель, даты, структура)

### Output (Выходные данные)
Все файлы сохраняются в директории `data/halyk_business_out/` (или указанной через `--out-dir`):

1. **`<stem>_header.csv`** - Заголовок выписки
   - Период, счет, остатки, дата выписки

2. **`<stem>_tx.csv`** - Транзакции
   - Все операции с датами, дебетами, кредитами, деталями платежа, контрагентом (имя и БИН/ИИН)

3. **`<stem>_footer.csv`** - Итоговая информация
   - Исходящий остаток, итоговые обороты

4. **`<stem>_meta.csv`** - Метаданные обработки
   - Банк, исходный PDF, флаги валидации

5. **`<stem>_tx_ip.csv`** - Транзакции с флагами ИП
   - Обогащенные транзакции с пометками о доходах ИП (только за последние 12 месяцев)

6. **`<stem>_ip_income_monthly.csv`** - Доходы ИП по месяцам
   - Агрегированные доходы по месяцам за последние 12 месяцев

7. **`<stem>_income_summary.csv`** - Сводка по доходам ИП
   - Общая и скорректированная сумма доходов

8. **`<stem>_ui_debit_top_9.csv`** - Топ-9 дебетовых операций
   - Топ-9 контрагентов по сумме дебетовых операций

9. **`<stem>_ui_credit_top_9.csv`** - Топ-9 кредитовых операций
   - Топ-9 контрагентов по сумме кредитовых операций

10. **`<stem>_ui_related_parties_net.csv`** - Связанные стороны (Net)
    - Анализ связанных сторон с чистыми суммами операций

---

## 7. Halyk Bank Individual

**Файл:** `src/halyk_ind/batch_parse.py`

### Input (Входные данные)
- **PDF файлы**: Выписки Halyk Bank (индивидуальные) в формате PDF
  - Расположение: `data/halyk_individual/*.pdf`
  - Можно указать один файл или директорию с файлами

### Промежуточные файлы (создаются автоматически)
- **JSONL страниц**: Создается во временной директории (удаляется после обработки)
  - Постраничный дамп PDF в формате pdfplumber

### Output (Выходные данные)
Все файлы сохраняются в директории `data/halyk_individual_out/` (или указанной через `--out-dir`):

1. **`<stem>_header.csv`** - Заголовок выписки
   - Информация о периоде и счете

2. **`<stem>_tx.csv`** - Транзакции
   - Все операции с датами, суммами, описанием операций
   - Описания очищены от префиксов ("Операция оплаты у коммерсанта", "Поступление перевода", и т.д.)

3. **`<stem>_footer.csv`** - Итоговая информация
   - Итоговые данные выписки

4. **`<stem>_ui_debit_top_9.csv`** - Топ-9 дебетовых операций
   - Топ-9 контрагентов по сумме дебетовых операций

5. **`<stem>_ui_credit_top_9.csv`** - Топ-9 кредитовых операций
   - Топ-9 контрагентов по сумме кредитовых операций

6. **`<stem>_ui_related_parties_net.csv`** - Связанные стороны (Net)
    - Анализ связанных сторон с чистыми суммами операций

---

## 8. Kaspi Gold

**Файл:** `src/kaspi_gold/batch_parse.py`

### Input (Входные данные)
- **PDF файлы**: Выписки Kaspi Gold в формате PDF
  - Расположение: `data/kaspi_gold/*.pdf`
  - Можно указать директорию с файлами

### Промежуточные файлы
- Не создаются промежуточные файлы (парсинг происходит напрямую из PDF)

### Output (Выходные данные)
Все файлы сохраняются в директории `data/kaspi_gold_out/` (или указанной через `--out-dir`):

1. **`<stem>_header.csv`** - Заголовок выписки
   - Информация о периоде, счете, остатках

2. **`<stem>_tx.csv`** - Транзакции
   - Все операции с датами, суммами, типом операции, деталями
   - Дополнительные колонки: `kp_person_name`, `kp_is_related_party`, `kp_outgoing_share_pct`, `kp_exclude_from_income`, `valid_for_ip_income`

3. **`<stem>_meta.csv`** - Метаданные выписки
   - Дополнительная информация о выписке

4. **`<stem>_tx_ip.csv`** - Транзакции с флагами ИП
   - Обогащенные транзакции с пометками о доходах ИП

5. **`<stem>_ip_income_monthly.csv`** - Доходы ИП по месяцам
   - Агрегированные доходы по месяцам

6. **`<stem>_income_summary.csv`** - Сводка по доходам ИП
   - Общая и скорректированная сумма доходов

7. **`<stem>_related_parties.csv`** - Связанные стороны (Legacy)
   - Анализ связанных сторон с процентами исходящих операций и флагами исключения

8. **`<stem>_ui_debit_top_9.csv`** - Топ-9 дебетовых операций
   - Топ-9 контрагентов по сумме дебетовых операций

9. **`<stem>_ui_credit_top_9.csv`** - Топ-9 кредитовых операций
   - Топ-9 контрагентов по сумме кредитовых операций

10. **`<stem>_ui_related_parties_net.csv`** - Связанные стороны (Net)
    - Анализ связанных сторон с чистыми суммами операций

---

## 9. Kaspi Pay

**Файл:** `src/kaspi_pay/batch_parse.py`

### Input (Входные данные)
- **PDF файлы**: Выписки Kaspi Pay в формате PDF
  - Расположение: `data/kaspi_pay/*.pdf`
  - Можно указать директорию с файлами

### Промежуточные файлы (создаются автоматически)
- **JSONL страниц**: Создается во временной директории (удаляется после обработки)
  - Постраничный дамп PDF в формате pdfplumber

### Output (Выходные данные)
Все файлы сохраняются в директории `data/kaspi_pay_out/` (или указанной через `--out-dir`):

1. **`<stem>_header.csv`** - Заголовок выписки
   - Информация о периоде, счете

2. **`<stem>_tx.csv`** - Транзакции
   - Все операции с датами, кредитами, дебетами, назначением платежа, наименованием получателя

3. **`<stem>_income_summary.csv`** - Сводка по доходам ИП
   - Общая и скорректированная сумма доходов

4. **`<stem>_ui_debit_top_9.csv`** - Топ-9 дебетовых операций
   - Топ-9 контрагентов по сумме дебетовых операций

5. **`<stem>_ui_credit_top_9.csv`** - Топ-9 кредитовых операций
   - Топ-9 контрагентов по сумме кредитовых операций

6. **`<stem>_ui_related_parties_net.csv`** - Связанные стороны (Net)
    - Анализ связанных сторон с чистыми суммами операций

---

## Общие замечания

### Параметры командной строки

Большинство batch-файлов поддерживают следующие параметры:

- `path` - Путь к PDF файлу или директории с PDF файлами (обязательный)
- `--out-dir` - Директория для выходных CSV файлов (по умолчанию: `<base_dir>_out`)
- `--jsonl-dir` - Директория для JSONL файлов (если требуется)
- `--pdf-meta-dir` - Директория для JSON метаданных (если требуется)
- `--months-back` - Количество месяцев для расчета доходов ИП (по умолчанию: 12)
- `--no-verbose` - Отключить подробный вывод

### Формат дат

- Большинство банков используют формат `%d.%m.%Y` (дд.мм.гггг)
- Freedom Bank и Kaspi Gold используют формат `%d.%m.%y` (дд.мм.гг)

### Кодировка выходных файлов

Все CSV файлы сохраняются с кодировкой `utf-8-sig` (UTF-8 с BOM) для корректного отображения в Excel.

### Валидация

Большинство парсеров выполняют:
- Числовую валидацию (проверка соответствия сумм в header/tx/footer)
- Валидацию метаданных PDF (даты создания, создатель, производитель)

Результаты валидации сохраняются в файле `*_meta.csv` в колонках `flags` и `debug_info`.

