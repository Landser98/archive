# Kaspi Pay - Batch Parser

## Описание

Batch-парсер для обработки выписок Kaspi Pay. Парсит PDF файлы, вычисляет доходы ИП и генерирует аналитические таблицы для UI.

## Использование

```bash
python src/kaspi_pay/batch_parse.py <input_dir> [опции]
```

### Параметры

- `input_dir` - Директория с PDF файлами (обязательный)
- `--out-dir` - Директория для выходных CSV файлов (по умолчанию: `<input_dir>_out`)

### Примеры

```bash
# Обработать все PDF в директории
python src/kaspi_pay/batch_parse.py data/kaspi_pay/

# Указать выходную директорию
python src/kaspi_pay/batch_parse.py data/kaspi_pay/ --out-dir results/
```

## Input (Входные данные)

### PDF файлы
- **Формат**: PDF выписки Kaspi Pay
- **Расположение**: `data/kaspi_pay/*.pdf`
- **Можно указать**: директорию с файлами (рекурсивный поиск)

## Промежуточные файлы

### JSONL страниц
- **Путь**: Создается во временной директории (удаляется после обработки)
- **Содержит**: постраничный дамп PDF в формате pdfplumber
- **Создается автоматически** и удаляется после обработки

## Output (Выходные данные)

Все файлы сохраняются в директории `data/kaspi_pay_out/` (или указанной через `--out-dir`):

### 1. `<stem>_header.csv`
Заголовок выписки
- Информация о периоде
- Информация о счете

### 2. `<stem>_tx.csv`
Транзакции
- Дата операции
- Дебет
- Кредит
- Назначение платежа
- Наименование получателя
- КНП (если доступно)

### 3. `<stem>_income_summary.csv`
Сводка по доходам ИП
- `total_income` - Общая сумма доходов
- `total_income_adjusted` - Скорректированная сумма (с учетом исключений)
- Дополнительная статистика

### 4. `<stem>_ui_debit_top_9.csv`
Топ-9 дебетовых операций
- Контрагент (наименование получателя)
- Сумма дебетовых операций
- Количество операций
- Ранг

### 5. `<stem>_ui_credit_top_9.csv`
Топ-9 кредитовых операций
- Контрагент (наименование получателя)
- Сумма кредитовых операций
- Количество операций
- Ранг

### 6. `<stem>_ui_related_parties_net.csv`
Связанные стороны (Net)
- Контрагент (наименование получателя)
- Чистая сумма операций (кредит - дебет)
- Количество операций
- Анализ связанных сторон

## Особенности

- Использует pdfplumber для извлечения данных из PDF
- JSONL файлы создаются во временной директории и автоматически удаляются
- Генерирует аналитические таблицы для UI (Топ-9 и связанные стороны)
- Объединяет "Назначение платежа" и "Наименование получателя" в `ip_text` для поиска ключевых слов дохода ИП
- Использует формат дат: `%d.%m.%Y` (дд.мм.гггг)

## Расчет дохода ИП

Для расчета дохода ИП парсер:
1. Объединяет "Назначение платежа" и "Наименование получателя" в единое поле `ip_text`
2. Ищет ключевые слова, указывающие на доходы ИП
3. Фильтрует транзакции по КНП (если доступно)
4. Вычисляет скорректированную сумму дохода

## Формат дат

- Формат дат в выписках: `%d.%m.%Y` (дд.мм.гггг)

## Кодировка

Все CSV файлы сохраняются с кодировкой `utf-8-sig` (UTF-8 с BOM) для корректного отображения в Excel.

