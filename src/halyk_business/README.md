# Halyk Bank Business - Batch Parser

## Описание

Batch-парсер для обработки выписок Halyk Bank (бизнес). Парсит PDF файлы, валидирует данные, вычисляет доходы ИП и генерирует аналитические таблицы для UI.

## Использование

```bash
python src/halyk_business/batch_parse.py <path> [опции]
```

### Параметры

- `path` - Путь к PDF файлу или директории с PDF файлами (обязательный)
- `--pattern` - Шаблон поиска файлов при указании директории (по умолчанию: `*.pdf`)
- `--out-dir` - Директория для выходных CSV файлов (по умолчанию: `<base_dir>/out`)
- `--jsonl-dir` - Директория для JSONL файлов (по умолчанию: `<base_dir>/converted_jsons`)
- `--pdf-meta-dir` - Директория для JSON метаданных (по умолчанию: `<base_dir>/pdf_meta`)
- `--months-back` - Количество месяцев для расчета доходов ИП (по умолчанию: 12)
- `--no-verbose` - Отключить подробный вывод

### Примеры

```bash
# Обработать один файл
python src/halyk_business/batch_parse.py data/halyk_business/statement.pdf

# Обработать все PDF в директории
python src/halyk_business/batch_parse.py data/halyk_business/

# Указать выходную директорию
python src/halyk_business/batch_parse.py data/halyk_business/ --out-dir results/
```

## Input (Входные данные)

### PDF файлы
- **Формат**: PDF выписки Halyk Bank (бизнес)
- **Расположение**: `data/halyk_business/*.pdf`
- **Можно указать**: один файл или директорию с файлами

## Промежуточные файлы

### JSONL страниц
- **Путь**: `data/halyk_business/converted_jsons/<stem>_pages.jsonl`
- **Содержит**: постраничный дамп PDF в формате pdfplumber
- **Создается автоматически** при первом запуске

### JSON метаданные
- **Путь**: `data/halyk_business/pdf_meta/<stem>.json`
- **Содержит**: метаданные PDF (версия, создатель, даты, структура)
- **Создается автоматически** при первом запуске

## Output (Выходные данные)

Все файлы сохраняются в директории `data/halyk_business_out/` (или указанной через `--out-dir`):

### 1. `<stem>_header.csv`
Заголовок выписки
- Период выписки
- Дата выписки
- Информация о счете
- Исходящий остаток

### 2. `<stem>_tx.csv`
Транзакции (все транзакции из выписки)
- Дата
- Дебет
- Кредит
- Детали платежа
- Контрагент (имя)
- Контрагент (БИН/ИИН)

### 3. `<stem>_footer.csv`
Итоговая информация
- Исходящий остаток
- Итоговые обороты

### 4. `<stem>_meta.csv`
Метаданные обработки
- `bank` - Название банка (HALYK_BUSINESS)
- `pdf_file` - Имя исходного PDF файла
- `flags` - Флаги валидации (разделенные точкой с запятой)

### 5. `<stem>_tx_ip.csv`
Транзакции с флагами ИП (только за последние 12 месяцев)
- Все колонки из `<stem>_tx.csv`
- Дополнительные флаги для идентификации доходов ИП
- Пометки об исключениях из расчета дохода
- **Важно**: содержит только транзакции за последние 12 полных месяцев

### 6. `<stem>_ip_income_monthly.csv`
Доходы ИП по месяцам
- Месяц
- Сумма дохода за месяц
- Количество транзакций
- **Период**: последние 12 полных месяцев

### 7. `<stem>_income_summary.csv`
Сводка по доходам ИП
- `total_income` - Общая сумма доходов
- `total_income_adjusted` - Скорректированная сумма (с учетом исключений)
- Дополнительная статистика

### 8. `<stem>_ui_debit_top_9.csv`
Топ-9 дебетовых операций
- Контрагент
- Сумма дебетовых операций
- Количество операций
- Ранг

### 9. `<stem>_ui_credit_top_9.csv`
Топ-9 кредитовых операций
- Контрагент
- Сумма кредитовых операций
- Количество операций
- Ранг

### 10. `<stem>_ui_related_parties_net.csv`
Связанные стороны (Net)
- Контрагент (имя и БИН/ИИН)
- Чистая сумма операций (кредит - дебет)
- Количество операций
- Анализ связанных сторон

## Особенности

- Использует pdfplumber для извлечения данных из PDF
- Требует JSONL файлы для парсинга (создаются автоматически)
- Выполняет числовую валидацию (если схема HALYK_BUSINESS зарегистрирована)
- Валидирует метаданные PDF (даты создания, создатель)
- **Фильтрует транзакции по последним 12 полным месяцам** для расчета доходов ИП
- Генерирует аналитические таблицы для UI (Топ-9 и связанные стороны)
- Поддерживает анализ связанных сторон по БИН/ИИН

## Формат дат

- Формат дат в выписках: `%d.%m.%Y` (дд.мм.гггг)

## Кодировка

Все CSV файлы сохраняются с кодировкой `utf-8-sig` (UTF-8 с BOM) для корректного отображения в Excel.

