# Kaspi Gold - Batch Parser

## Описание

Batch-парсер для обработки выписок Kaspi Gold. Парсит PDF файлы, вычисляет доходы ИП, анализирует связанные стороны и генерирует аналитические таблицы для UI.

## Использование

```bash
python src/kaspi_gold/batch_parse.py <input_dir> [опции]
```

### Параметры

- `input_dir` - Директория с PDF файлами (обязательный)
- `--out-dir` - Директория для выходных CSV файлов (по умолчанию: `<input_dir>_out`)
- `--max-files` - Лимит количества обрабатываемых файлов (по умолчанию: 0 = без лимита)

### Примеры

```bash
# Обработать все PDF в директории
python src/kaspi_gold/batch_parse.py data/kaspi_gold/

# Указать выходную директорию
python src/kaspi_gold/batch_parse.py data/kaspi_gold/ --out-dir results/

# Обработать только первые 10 файлов
python src/kaspi_gold/batch_parse.py data/kaspi_gold/ --max-files 10
```

## Input (Входные данные)

### PDF файлы
- **Формат**: PDF выписки Kaspi Gold
- **Расположение**: `data/kaspi_gold/*.pdf`
- **Можно указать**: директорию с файлами (рекурсивный поиск)

## Промежуточные файлы

- Промежуточные файлы не создаются (парсинг происходит напрямую из PDF)

## Output (Выходные данные)

Все файлы сохраняются в директории `data/kaspi_gold_out/` (или указанной через `--out-dir`):

### 1. `<stem>_header.csv`
Заголовок выписки
- Информация о периоде
- Информация о счете
- Остатки

### 2. `<stem>_tx.csv`
Транзакции
- `date` - Дата операции
- `amount` - Сумма операции
- `operation` - Тип операции
- `details` - Детали операции
- `kp_person_name` - Имя связанной стороны (если найдено)
- `kp_is_related_party` - Флаг связанной стороны
- `kp_outgoing_share_pct` - Процент исходящих операций (для связанных сторон)
- `kp_exclude_from_income` - Флаг исключения из расчета дохода
- `valid_for_ip_income` - Флаг валидности для расчета дохода ИП

### 3. `<stem>_meta.csv`
Метаданные выписки
- Дополнительная информация о выписке

### 4. `<stem>_tx_ip.csv`
Транзакции с флагами ИП
- Все колонки из `<stem>_tx.csv`
- Дополнительные флаги для идентификации доходов ИП
- Пометки об исключениях из расчета дохода

### 5. `<stem>_ip_income_monthly.csv`
Доходы ИП по месяцам
- Месяц
- Сумма дохода за месяц
- Количество транзакций

### 6. `<stem>_income_summary.csv`
Сводка по доходам ИП
- `total_income` - Общая сумма доходов
- `total_income_adjusted` - Скорректированная сумма (с учетом исключений)
- Дополнительная статистика

### 7. `<stem>_related_parties.csv`
Связанные стороны (Legacy формат)
- `person_name` - Имя связанной стороны
- `total_incoming` - Общая сумма входящих операций
- `total_outgoing` - Общая сумма исходящих операций
- `outgoing_share_pct` - Процент исходящих операций
- `exclude_from_income` - Флаг исключения из расчета дохода

### 8. `<stem>_ui_debit_top_9.csv`
Топ-9 дебетовых операций
- Контрагент
- Сумма дебетовых операций
- Количество операций
- Ранг

### 9. `<stem>_ui_credit_top_9.csv`
Топ-9 кредитовых операций
- Контрагент
- Сумма кредитовых операций
- Количество операций
- Ранг

### 10. `<stem>_ui_related_parties_net.csv`
Связанные стороны (Net)
- Контрагент
- Чистая сумма операций (кредит - дебет)
- Количество операций
- Анализ связанных сторон

## Особенности

- Парсинг происходит напрямую из PDF (без промежуточных файлов)
- **Анализ связанных сторон**: автоматически определяет связанные стороны по именам в деталях операций
- **Исключение связанных сторон**: связанные стороны с высоким процентом исходящих операций исключаются из расчета дохода ИП
- Генерирует аналитические таблицы для UI (Топ-9 и связанные стороны)
- Использует специальный формат дат: `%d.%m.%y` (дд.мм.гг)
- Объединяет `operation` и `details` в `ip_text` для поиска ключевых слов дохода ИП

## Анализ связанных сторон

Парсер автоматически:
1. Извлекает имена людей из деталей операций
2. Анализирует соотношение входящих и исходящих операций
3. Помечает связанные стороны с высоким процентом исходящих операций
4. Исключает такие транзакции из расчета дохода ИП

## Формат дат

- Формат дат в выписках: `%d.%m.%y` (дд.мм.гг) - **отличается от большинства других банков**

## Кодировка

Все CSV файлы сохраняются с кодировкой `utf-8-sig` (UTF-8 с BOM) для корректного отображения в Excel.

